(function(){var e,t=utility.getLocalStorage("language"),i=utility.getLocalStorage("userInfo"),a=utility.getLocalStorage("bizParam"),n=(utility.getSessionStorage("fromMap"),[]),r=[],o=new Vue({el:"#js-vue",data:{filterDepart:[],language:t?t.language:"CN",isTableLoading:!0,isShowModal:!1,isShowDetail:!1,isModalLoading:!0,modalTitle:"",vehicleTypeList:a.vehicleType,tableHeight:(e=$(".tableContainer").height(),e-100),pageInfo:{id:0,count:0,companyId:"",deptIds:[],vehicleTypeId:"",vehicleName:"",licenseNumber:"",beginTime:"",endTime:""},page:{pageSize:20,pageNum:1,count:0},index:0,selectItem:"",itemInfo:{id:"",dealFlag:"",remark:"",createUserId:i.id,modifyUserId:i.id},columnsList:[{type:"index",align:"center",title:"序号",width:60},{title:"公司名称",key:"companyName"},{title:"部门名称",key:"deptName"},{title:"车辆名称",key:"vehicleName"},{title:"车牌号",key:"licenseNumber"},{title:"车辆类型",key:"vehicleTypeName"},{title:"总使用流量",key:"dayCardFlow",render:function(e,t){return e("div",t.row.dayCardFlow+"M")}},{title:"开始统计时间",key:"beginTime"},{title:"结束统计时间",key:"endTime"},{title:"操作",key:"operation",align:"center",render:function(e,t){return e("div",[e("Button",{props:{type:"primary",size:"small"},style:{marginRight:"5px"},on:{click:function(){o.index=t.index,o.selectItem=t.row,o.showDetail()}}},"详情")])}}],tableRowList:[],userList:[],companyList:[],alarmList:[],superiorDepartmentList:[],deptUserPositionTypeList:a.departmentPositionType,sumNumber:0,totalNumber:0,countCar:0,currentMonth:"",monthDays:0,dateInfo:{}},methods:{refresh:function(){var e=this;window.location.href=window.location.href,0==e.isTableLoading&&(e.isTableLoading=!0,setTimeout(function(){e.isTableLoading=!1},3e3))},addItem:function(){var e=this;e.isShowModal=!0,e.isModalLoading=!0,e.modalTitle={CN:"新增",EN:"Add",TW:"新增"}[e.language],e.itemInfo={remark:"",dealFlag:"",createUserId:i.id,modifyUserId:i.id}},editItem:function(){var e=this;utility.showMessageTip(e,function(){e.itemInfo=e.alarmList[e.index],e.isShowModal=!0,e.modalTitle={CN:"修改",EN:"Edit",TW:"修改"}[e.language]})},showDetail:function(){var e=this;utility.showMessageTip(e,function(){e.itemInfo=JSON.parse(JSON.stringify(e.alarmList[e.index])),e.isShowDetail=!0})},beginRepairTime:function(e,t){var i=this;i.pageInfo.beginTime=e},endRepairTime:function(e,t){var i=this;i.pageInfo.endTime=e},setCurrentRowData:function(e,t){var i=this;e&&(i.index=t,i.selectItem=e)},pageSizeChange:function(e){var t=this;t.page.pageNum=parseInt(e,10),setTimeout(function(){t.getAlarmList(!1)},200)},pageRowChange:function(e){var t=this;t.page.pageSize=parseInt(e,10),setTimeout(function(){t.getAlarmList(!0)},200)},getAlarmList:function(e,t){var i=this,a={pageNum:i.page.pageNum,pageSize:i.page.pageSize,licenseNumber:encodeURI(i.pageInfo.licenseNumber),vehicleTypeId:i.pageInfo.vehicleTypeId,beginTime:i.pageInfo.beginTime,endTime:i.pageInfo.endTime,companyId:i.pageInfo.companyId,deptId:i.pageInfo.deptIds[i.pageInfo.deptIds.length-1]||0};t||(i.tableRowList=[],i.alarmList=[],i.isTableLoading=!0),1==e&&(i.page.pageNum=1,i.page.count=0),t&&1==t.isChart&&(a={pageNum:1,pageSize:1,beginTime:t.beginTime+" 00:00:00",endTime:t.endTime+" 23:59:59"}),utility.interactWithServer({url:CONFIG.HOST+CONFIG.SERVICE.vehicleService+"?action="+CONFIG.ACTION.getVehicleCardFlowStat,actionUrl:CONFIG.SERVICE.vehicleService,dataObj:a,async:!!t,completeCallback:function(){i.isTableLoading=!1},successCallback:function(e){200==e.code&&(t||(i.page.count=e.count,i.sumNumber=e.sum,i.alarmList=e.data)),t&&1==t.isChart&&t.callback&&t.callback(e.sum||0)}})},getCompanyList:function(){var e=this;utility.interactWithServer({url:CONFIG.HOST+CONFIG.SERVICE.companyService+"?action="+CONFIG.ACTION.getCompanyList,actionUrl:CONFIG.SERVICE.companyService,dataObj:{id:0,pageSize:1e4},successCallback:function(t){if(200==t.code){e.companyList=t.data;for(var i=0,a=e.companyList.length;i<a;i++)n.push({label:e.companyList[i].companyName,value:e.companyList[i].id})}}})},getSuper:function(e,t,i){for(var a=this,n=0,r=e.length;n<r;n++)if(e[n].value==t){if(i.push(t),0==e[n].paraDeptId)return;a.getSuper(a.superiorDepartmentList,e[n].paraDeptId,i)}else a.getSuper(e[n].children,t,i)},formatSuperiorDeprt:function(e){var t=this,i=JSON.stringify(e).replace(/id/g,"value").replace(/deptName/g,"label").replace(/subDeptList/g,"children");t.superiorDepartmentList=JSON.parse(i)},getSuperiorDeprtList:function(e){var t=this;t.superiorDepartmentList=[],utility.interactWithServer({url:CONFIG.HOST+CONFIG.SERVICE.deptService+"?action="+CONFIG.ACTION.getDeptTreeList,actionUrl:CONFIG.SERVICE.deptService,dataObj:{id:0,pageSize:1e4,companyId:t[e].companyId||0},successCallback:function(i){if(200==i.code){var a=[];t[e].deptIds=[],t.formatSuperiorDeprt(i.data),t.getSuper(t.superiorDepartmentList,t[e].deptId,a),t[e].deptIds=a.reverse()}}})},getDepartmentList:function(){var e=this;utility.interactWithServer({url:CONFIG.HOST+CONFIG.SERVICE.deptService+"?action="+CONFIG.ACTION.getDeptList,actionUrl:CONFIG.SERVICE.deptService,dataObj:{pageNum:1,pageSize:1e4,companyId:e.pageInfo.companyId[0]||0},successCallback:function(e){if(200==e.code)for(var t=0,i=e.data.length;t<i;t++)r.push({label:e.data[t].deptName,value:e.data[t].id})}})},getDepartAndUser:function(){var e=this;e.itemInfo.userIds=[],e.getSuperiorDeprtList("itemInfo")},toMapTrack:function(e){utility.setSessionStorage("fromInfo",null),utility.setSessionStorage("vehicleTrackFrom",e),setTimeout(function(){$(window.parent.document).find("#nav_Maps").bind("click"),$(window.parent.document).find("#nav_Maps").trigger("click")},200)},getAllVehicleList:function(e){utility.interactWithServer({url:CONFIG.HOST+CONFIG.SERVICE.vehicleService+"?action="+CONFIG.ACTION.getAllVehiclePositonList,actionUrl:CONFIG.SERVICE.vehicleService,dataObj:{pageNum:1,pageSize:1e9},successCallback:function(t){200==t.code&&e&&e(12*t.count*1024,t.count)}})},drawPie:function(e,t,i){var a=echarts.init(document.getElementById("illegaInfo"));option={color:["#d14a61","#2d8cf0"],title:{text:e+"月份流量使用情况",top:10,left:"center"},center:"30%",tooltip:{trigger:"item",formatter:"{c}G({d}%)"},series:[{type:"pie",radius:"60%",center:[150,155],top:40,label:{formatter:"{b}{c}G\n{d}%"},data:[{value:Math.round(t/1024),name:"使用"},{value:Math.round((i-t)/1024),name:"剩下"}]}]},a.setOption(option)},drawLine:function(e,t,i){var a=echarts.init(document.getElementById("milleInfo"));option={color:["#d14a61","#2d8cf0"],title:{text:e+"月份每天流量使用情况",top:10,left:"center"},grid:{left:80,top:60,right:20,bottom:40},tooltip:{trigger:"item",formatter:"{b}号：{c}M"},legend:{data:["流量"],left:10},xAxis:{type:"category",data:function(){for(var e=[],i=0;i<t;i++)e.push(i+1);return e}()},yAxis:{type:"value"},series:[{data:i,type:"line",symbolSize:8}]},a.setOption(option)},changeMonth:function(e){var t=this;t.currentMonth=parseInt(e||t.dateInfo.month,10),t.monthDays=new Date(t.dateInfo.year,t.currentMonth,0).getDate(),t.drawGraph()},drawGraph:function(){var e=this,t={},i=[],a=[];e.getAlarmList(!1,{isChart:!0,beginTime:e.dateInfo.year+"-"+e.currentMonth+"-01",endTime:e.dateInfo.year+"-"+e.currentMonth+"-"+e.monthDays,callback:function(t){e.drawPie(e.currentMonth,t,e.totalNumber)}});for(var n=0;n<e.monthDays;n++)(function(n){e.getAlarmList(!1,{isChart:!0,beginTime:e.dateInfo.year+"-"+e.currentMonth+"-"+(n+1),endTime:e.dateInfo.year+"-"+e.currentMonth+"-"+(n+1),callback:function(r){if(t["_"+n]=r,i.push(r),i.length==e.monthDays){for(var o=0;o<e.monthDays;o++)a.push(t["_"+o]);e.drawLine(e.currentMonth,e.monthDays,a)}}})})(n)}},created:function(){var e=this;e.dateInfo=utility.getDateDetailInfo(),e.currentMonth=parseInt(e.dateInfo.month),e.monthDays=new Date(e.dateInfo.year,e.currentMonth,0).getDate(),utility.isLogin(!1),e.getAllVehicleList(function(t,i){e.totalNumber=t,e.countCar=i,e.getAlarmList(!0),e.getCompanyList(),e.drawGraph()}),e.$watch("pageInfo",function(){e.getAlarmList(!0)},{deep:!0})}})})();
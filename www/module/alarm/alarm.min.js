(function(){var e,t=utility.getLocalStorage("language"),a=utility.getLocalStorage("userInfo"),i=utility.getLocalStorage("bizParam"),n=utility.getSessionStorage("fromMap"),r=[],l=[],o=[{label:"拆卸",value:1},{label:"超速",value:2},{label:"电量低",value:3},{label:"进入防区",value:501},{label:"离开防区",value:502},{label:"防区内停留",value:503},{label:"防区内行驶",value:504},{label:"防区内超速",value:505}],s=[{label:"未处理",value:0},{label:"处理中",value:1},{label:"已处理",value:2}],d=new Vue({el:"#js-vue",data:{filterDepart:[],language:t?t.language:"CN",isTableLoading:!0,isShowModal:!1,isShowDetail:!1,isModalLoading:!0,modalTitle:"",tableHeight:(e=$(".tableContainer").height(),e-100),pageInfo:{id:0,count:0,companyId:"",deptIds:[],eventTypeId:"",dealFlag:"",vehicleName:"",licenseNumber:"",beginTime:"",endTime:""},page:{pageSize:20,pageNum:1},index:0,selectItem:"",itemInfo:{id:"",dealFlag:"",remark:"",createUserId:a.id,modifyUserId:a.id},columnsList:[{type:"index",align:"center",title:"序号",width:60,fixed:"left"},{title:"公司名称",key:"companyName",width:180,fixed:"left",filters:r,filterMultiple:!1,filterRemote(e,t){d.pageInfo.companyId=e,d.getDepartmentList()}},{title:"部门名称",key:"deptName",width:150,filters:l,filterMultiple:!1,filterRemote(e,t){d.pageInfo.deptIds=e}},{title:"报警类型",key:"alarmTypeDesc",width:100},{title:"处理状态",key:"dealDesc",width:100,filters:s,filterMultiple:!1,filterRemote(e,t){d.pageInfo.dealFlag=e[0]}},{title:"警报事件",key:"eventTypeDesc",width:100,filters:o,filterMultiple:!1,filterRemote(e,t){d.pageInfo.eventTypeId=e[0]},render:function(e,t){var a={_1:"拆卸",_2:"超速",_3:"电量低",_501:"进入防区",_502:"离开防区",_503:"防区内停留",_504:"防区内行驶",_505:"防区内超速"};return e("div",[e("span",{},t.row.eventTypeDesc||a["_"+t.row.eventTypeId])])}},{title:"车牌号",key:"licenseNumber",width:150},{title:"报警时间",key:"alarmTime",width:130},{title:"报警内容",key:"alarmInfo",width:400},{title:"报警坐标",key:"gpsPositionStr",width:120},{title:"报警地址",key:"alarmAddress",width:350},{title:{CN:"操作",EN:"Operation",TW:"操作"}[t.language],key:"operation",fixed:"right",align:"center",width:160,render:function(e,t){return e("div",[e("Button",{props:{type:"primary",size:"small"},style:{marginRight:"5px"},on:{click:function(){d.index=t.index,d.selectItem=t.row,d.showDetail()}}},"详情"),e("Button",{props:{type:"warning",size:"small"},style:{marginRight:"5px"},on:{click:function(){d.index=t.index,d.selectItem=t.row,d.editItem()}}},"处理异常")])}}],tableRowList:[],userList:[],companyList:[],alarmList:[],superiorDepartmentList:[],deptUserPositionTypeList:i.departmentPositionType},methods:{refresh:function(){var e=this;window.location.href=window.location.href,0==e.isTableLoading&&(e.isTableLoading=!0,setTimeout(function(){e.isTableLoading=!1},3e3))},addItem:function(){var e=this;e.isShowModal=!0,e.isModalLoading=!0,e.modalTitle={CN:"新增",EN:"Add",TW:"新增"}[e.language],e.itemInfo={remark:"",dealFlag:"",createUserId:a.id,modifyUserId:a.id}},editItem:function(){var e=this;utility.showMessageTip(e,function(){e.itemInfo=e.alarmList[e.index],e.isShowModal=!0,e.modalTitle={CN:"修改",EN:"Edit",TW:"修改"}[e.language]})},showDetail:function(){var e=this;utility.showMessageTip(e,function(){e.itemInfo=JSON.parse(JSON.stringify(e.alarmList[e.index])),e.isShowDetail=!0})},beginRepairTime:function(e,t){var a=this;a.pageInfo.beginTime=e},endRepairTime:function(e,t){var a=this;a.pageInfo.endTime=e},setCurrentRowData:function(e,t){var a=this;e&&(a.index=t,a.selectItem=e)},uploadDataToServer:function(){var e=this;utility.interactWithServer({url:CONFIG.HOST+CONFIG.SERVICE.alarmService+"?action="+CONFIG.ACTION.updateAlarmStatus,actionUrl:CONFIG.SERVICE.alarmService,dataObj:{id:e.itemInfo.id,createUserId:a.id,modifyUserId:a.id,dealFlag:e.itemInfo.dealFlag,remark:encodeURI(e.itemInfo.remark)},completeCallback:function(){e.isModalLoading=!1},successCallback:function(t){200==t.code?(e.getAlarmList(!0),e.isShowModal=!1):e.$Message.error(t.message)}})},pageSizeChange:function(e){var t=this;t.page.pageNum=parseInt(e,10),setTimeout(function(){t.getAlarmList(!1)},200)},pageRowChange:function(e){var t=this;t.page.pageSize=parseInt(e,10),setTimeout(function(){t.getAlarmList(!1)},200)},getAlarmList:function(e){var t=this;t.tableRowList=[],1==e&&(t.page.pageNum=1),utility.interactWithServer({url:CONFIG.HOST+CONFIG.SERVICE.alarmService+"?action="+CONFIG.ACTION.getAlarmList,actionUrl:CONFIG.SERVICE.alarmService,dataObj:{pageNum:t.page.pageNum,pageSize:t.page.pageSize,alarmTypeId:t.pageInfo.alarmTypeId,eventTypeId:t.pageInfo.eventTypeId,dealFlag:t.pageInfo.dealFlag,licenseNumber:encodeURI(t.pageInfo.licenseNumber),beginTime:t.pageInfo.beginTime,endTime:t.pageInfo.endTime,companyId:t.pageInfo.companyId,deptId:t.pageInfo.deptIds[t.pageInfo.deptIds.length-1]||0},beforeSendCallback:function(){t.isTableLoading=!0},completeCallback:function(){t.isTableLoading=!1},successCallback:function(e){if(200==e.code){var a=[];t.pageInfo.count=e.count;for(var i=0,n=e.data.length;i<n;i++)a.push(e.data[i]),a[i].alarmAddress="";t.alarmList=a;for(var r=0;r<e.data.length;r++)(function(a){if(e.data[a].lastPosition){var i=JSON.parse(e.data[a].lastPosition).coordinates;0!=i[0]&&0!=i[1]?utility.convertorByBaidu(i,gcoord,BMap,function(e,i,n){utility.getAdressDetail([i,n],BMap,function(e){t.alarmList[a].alarmAddress=e})}):t.alarmList[a].alarmAddress="--"}else t.alarmList[a].alarmAddress="--"})(r)}}})},getCompanyList:function(){var e=this;utility.interactWithServer({url:CONFIG.HOST+CONFIG.SERVICE.companyService+"?action="+CONFIG.ACTION.getCompanyList,actionUrl:CONFIG.SERVICE.companyService,dataObj:{id:0,pageSize:1e4},successCallback:function(t){if(200==t.code){e.companyList=t.data;for(var a=0,i=e.companyList.length;a<i;a++)r.push({label:e.companyList[a].companyName,value:e.companyList[a].id})}}})},getSuper:function(e,t,a){for(var i=this,n=0,r=e.length;n<r;n++)if(e[n].value==t){if(a.push(t),0==e[n].paraDeptId)return;i.getSuper(i.superiorDepartmentList,e[n].paraDeptId,a)}else i.getSuper(e[n].children,t,a)},formatSuperiorDeprt:function(e){var t=this,a=JSON.stringify(e).replace(/id/g,"value").replace(/deptName/g,"label").replace(/subDeptList/g,"children");t.superiorDepartmentList=JSON.parse(a)},getSuperiorDeprtList:function(e){var t=this;t.superiorDepartmentList=[],utility.interactWithServer({url:CONFIG.HOST+CONFIG.SERVICE.deptService+"?action="+CONFIG.ACTION.getDeptTreeList,actionUrl:CONFIG.SERVICE.deptService,dataObj:{id:0,pageSize:1e4,companyId:t[e].companyId||0},successCallback:function(a){if(200==a.code){var i=[];t[e].deptIds=[],t.formatSuperiorDeprt(a.data),t.getSuper(t.superiorDepartmentList,t[e].deptId,i),t[e].deptIds=i.reverse()}}})},getDepartmentList:function(){var e=this;utility.interactWithServer({url:CONFIG.HOST+CONFIG.SERVICE.deptService+"?action="+CONFIG.ACTION.getDeptList,actionUrl:CONFIG.SERVICE.deptService,dataObj:{pageNum:1,pageSize:1e4,companyId:e.pageInfo.companyId[0]||0},successCallback:function(e){if(200==e.code)for(var t=0,a=e.data.length;t<a;t++)l.push({label:e.data[t].deptName,value:e.data[t].id})}})},getUserList:function(e){var t=this;t.userList=[],utility.interactWithServer({url:CONFIG.HOST+CONFIG.SERVICE.userService+"?action="+CONFIG.ACTION.getUserList,actionUrl:CONFIG.SERVICE.userService,dataObj:{id:0,pageSize:1e4,companyId:t.itemInfo.companyId},successCallback:function(a){200==a.code&&(t.userList=a.data,e&&e())}})},getDepartAndUser:function(){var e=this;e.itemInfo.userIds=[],e.getUserList(),e.getSuperiorDeprtList("itemInfo")}},created:function(){var e=this;utility.isLogin(!1),n&&(e.pageInfo.vehicleName=n.vehicleName,e.pageInfo.licenseNumber=n.licenseNumber),setTimeout(function(){e.getAlarmList(!0),e.getCompanyList(),e.$watch("pageInfo",function(){e.getAlarmList(!0)},{deep:!0})},500)}})})();
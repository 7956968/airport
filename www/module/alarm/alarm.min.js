(function(){var e,t=utility.getLocalStorage("language"),i=utility.getLocalStorage("userInfo"),a=utility.getLocalStorage("bizParam"),n=(utility.getSessionStorage("fromMap"),[]),r=[],l=[{label:"拆卸",value:1},{label:"超速",value:2},{label:"电量低",value:3},{label:"硬盘故障",value:4},{label:"进入防区",value:501},{label:"离开防区",value:502},{label:"防区内停留",value:503},{label:"防区内行驶",value:504},{label:"防区内超速",value:505}],o=[{label:"未处理",value:0},{label:"处理中",value:1},{label:"已处理",value:2}],s=new Vue({el:"#js-vue",data:{filterDepart:[],language:t?t.language:"CN",isTableLoading:!0,isShowModal:!1,isShowDetail:!1,isModalLoading:!0,modalTitle:"",tableHeight:(e=$(".tableContainer").height(),e-100),pageInfo:{id:0,count:0,companyId:"",deptIds:[],eventTypeId:"",dealFlag:"",vehicleName:"",licenseNumber:"",beginTime:"",endTime:""},page:{pageSize:20,pageNum:1},index:0,selectItem:"",itemInfo:{id:"",dealFlag:"",remark:"",createUserId:i.id,modifyUserId:i.id},columnsList:[{type:"index",align:"center",title:"序号",width:60,fixed:"left"},{title:"公司名称",key:"companyName",width:180,fixed:"left",filters:n,filterMultiple:!1,filterRemote(e,t){s.pageInfo.companyId=e,s.getDepartmentList()}},{title:"部门名称",key:"deptName",width:150,filters:r,filterMultiple:!1,filterRemote(e,t){s.pageInfo.deptIds=e}},{title:"报警类型",key:"alarmTypeDesc",width:100},{title:"处理状态",key:"dealDesc",width:100,filters:o,filterMultiple:!1,filterRemote(e,t){s.pageInfo.dealFlag=e[0]}},{title:"警报事件",key:"eventTypeDesc",width:100,filters:l,filterMultiple:!1,filterRemote(e,t){s.pageInfo.eventTypeId=e[0]},render:function(e,t){var i={_1:"拆卸",_2:"超速",_3:"电量低",_4:"硬盘故障",_501:"进入防区",_502:"离开防区",_503:"防区内停留",_504:"防区内行驶",_505:"防区内超速"};return e("div",[e("span",{},t.row.eventTypeDesc||i["_"+t.row.eventTypeId])])}},{title:"车牌号",key:"licenseNumber",width:150},{title:"报警时间",key:"alarmTime",width:130},{title:"报警内容",key:"alarmInfo",width:400},{title:"报警坐标",key:"gpsPositionStr",width:140},{title:"报警地址",key:"alarmAddress",width:350},{title:{CN:"操作",EN:"Operation",TW:"操作"}[t.language],key:"operation",fixed:"right",align:"center",width:160,render:function(e,t){return e("div",[e("Button",{props:{type:"primary",size:"small"},style:{marginRight:"5px"},on:{click:function(){s.index=t.index,s.selectItem=t.row,s.showDetail()}}},"详情"),e("Button",{props:{type:"warning",size:"small"},style:{marginRight:"5px"},on:{click:function(){s.index=t.index,s.selectItem=t.row,s.editItem()}}},"处理异常")])}}],tableRowList:[],userList:[],companyList:[],alarmList:[],superiorDepartmentList:[],deptUserPositionTypeList:a.departmentPositionType},methods:{refresh:function(){var e=this;window.location.href=window.location.href,0==e.isTableLoading&&(e.isTableLoading=!0,setTimeout(function(){e.isTableLoading=!1},3e3))},addItem:function(){var e=this;e.isShowModal=!0,e.isModalLoading=!0,e.modalTitle={CN:"新增",EN:"Add",TW:"新增"}[e.language],e.itemInfo={remark:"",dealFlag:"",createUserId:i.id,modifyUserId:i.id}},editItem:function(){var e=this;utility.showMessageTip(e,function(){e.itemInfo=e.alarmList[e.index],e.isShowModal=!0,e.modalTitle={CN:"修改",EN:"Edit",TW:"修改"}[e.language]})},showDetail:function(){var e=this;utility.showMessageTip(e,function(){e.itemInfo=JSON.parse(JSON.stringify(e.alarmList[e.index])),e.isShowDetail=!0})},beginRepairTime:function(e,t){var i=this;i.pageInfo.beginTime=e},endRepairTime:function(e,t){var i=this;i.pageInfo.endTime=e},setCurrentRowData:function(e,t){var i=this;e&&(i.index=t,i.selectItem=e)},uploadDataToServer:function(){var e=this;utility.interactWithServer({url:CONFIG.HOST+CONFIG.SERVICE.alarmService+"?action="+CONFIG.ACTION.updateAlarmStatus,actionUrl:CONFIG.SERVICE.alarmService,dataObj:{id:e.itemInfo.id,createUserId:i.id,modifyUserId:i.id,dealFlag:e.itemInfo.dealFlag,remark:encodeURI(e.itemInfo.remark)},completeCallback:function(){e.isModalLoading=!1},successCallback:function(t){200==t.code?(e.getAlarmList(!0),e.isShowModal=!1):e.$Message.error(t.message)}})},pageSizeChange:function(e){var t=this;t.page.pageNum=parseInt(e,10),setTimeout(function(){t.getAlarmList(!1)},200)},pageRowChange:function(e){var t=this;t.page.pageSize=parseInt(e,10),setTimeout(function(){t.getAlarmList(!0)},200)},getAlarmList:function(e){var t=this;t.tableRowList=[],t.alarmList=[],1==e&&(t.page.pageNum=1,t.page.count=0),utility.interactWithServer({url:CONFIG.HOST+CONFIG.SERVICE.alarmService+"?action="+CONFIG.ACTION.getAlarmList,actionUrl:CONFIG.SERVICE.alarmService,dataObj:{pageNum:t.page.pageNum,pageSize:t.page.pageSize,alarmTypeId:t.pageInfo.alarmTypeId,eventTypeId:t.pageInfo.eventTypeId,dealFlag:t.pageInfo.dealFlag,licenseNumber:encodeURI(t.pageInfo.licenseNumber),beginTime:t.pageInfo.beginTime,endTime:t.pageInfo.endTime,companyId:t.pageInfo.companyId,deptId:t.pageInfo.deptIds[t.pageInfo.deptIds.length-1]||0},beforeSendCallback:function(){t.isTableLoading=!0},completeCallback:function(){t.isTableLoading=!1},successCallback:function(e){if(200==e.code){var i=[];t.pageInfo.count=e.count;for(var a=0,n=e.data.length;a<n;a++)i.push(e.data[a]),i[a].alarmAddress="";t.alarmList=i;for(var r=0;r<e.data.length;r++)(function(i){if(e.data[i].gpsPositionStr){var a=e.data[i].gpsPositionStr.split(","),n=[a[0],a[1]];0!=n[0]&&0!=n[1]?utility.convertorByBaidu(n,gcoord,BMap,function(e,a,n){utility.getAdressDetail([a,n],BMap,function(e){t.alarmList[i].alarmAddress=e})}):t.alarmList[i].alarmAddress="--"}else t.alarmList[i].alarmAddress="--"})(r)}}})},getCompanyList:function(){var e=this;utility.interactWithServer({url:CONFIG.HOST+CONFIG.SERVICE.companyService+"?action="+CONFIG.ACTION.getCompanyList,actionUrl:CONFIG.SERVICE.companyService,dataObj:{id:0,pageSize:1e4},successCallback:function(t){if(200==t.code){e.companyList=t.data;for(var i=0,a=e.companyList.length;i<a;i++)n.push({label:e.companyList[i].companyName,value:e.companyList[i].id})}}})},getSuper:function(e,t,i){for(var a=this,n=0,r=e.length;n<r;n++)if(e[n].value==t){if(i.push(t),0==e[n].paraDeptId)return;a.getSuper(a.superiorDepartmentList,e[n].paraDeptId,i)}else a.getSuper(e[n].children,t,i)},formatSuperiorDeprt:function(e){var t=this,i=JSON.stringify(e).replace(/id/g,"value").replace(/deptName/g,"label").replace(/subDeptList/g,"children");t.superiorDepartmentList=JSON.parse(i)},getSuperiorDeprtList:function(e){var t=this;t.superiorDepartmentList=[],utility.interactWithServer({url:CONFIG.HOST+CONFIG.SERVICE.deptService+"?action="+CONFIG.ACTION.getDeptTreeList,actionUrl:CONFIG.SERVICE.deptService,dataObj:{id:0,pageSize:1e4,companyId:t[e].companyId||0},successCallback:function(i){if(200==i.code){var a=[];t[e].deptIds=[],t.formatSuperiorDeprt(i.data),t.getSuper(t.superiorDepartmentList,t[e].deptId,a),t[e].deptIds=a.reverse()}}})},getDepartmentList:function(){var e=this;utility.interactWithServer({url:CONFIG.HOST+CONFIG.SERVICE.deptService+"?action="+CONFIG.ACTION.getDeptList,actionUrl:CONFIG.SERVICE.deptService,dataObj:{pageNum:1,pageSize:1e4,companyId:e.pageInfo.companyId[0]||0},successCallback:function(e){if(200==e.code)for(var t=0,i=e.data.length;t<i;t++)r.push({label:e.data[t].deptName,value:e.data[t].id})}})},getUserList:function(e){var t=this;t.userList=[],utility.interactWithServer({url:CONFIG.HOST+CONFIG.SERVICE.userService+"?action="+CONFIG.ACTION.getUserList,actionUrl:CONFIG.SERVICE.userService,dataObj:{id:0,pageSize:1e4,companyId:t.itemInfo.companyId},successCallback:function(i){200==i.code&&(t.userList=i.data,e&&e())}})},getDepartAndUser:function(){var e=this;e.itemInfo.userIds=[],e.getUserList(),e.getSuperiorDeprtList("itemInfo")},toMapTrack:function(e){utility.setSessionStorage("fromInfo",null),utility.setSessionStorage("vehicleTrackFrom",e),setTimeout(function(){$(window.parent.document).find("#nav_Maps").bind("click"),$(window.parent.document).find("#nav_Maps").trigger("click")},200)}},created:function(){var e=this;utility.isLogin(!1),setTimeout(function(){utility.getSessionStorage("fromMap")&&(e.pageInfo.licenseNumber=utility.getSessionStorage("fromMap").licenseNumber,setTimeout(function(){utility.setSessionStorage("fromMap",null)},1500))},500),setTimeout(function(){e.getAlarmList(!0),e.getCompanyList(),e.$watch("pageInfo",function(){e.getAlarmList(!0)},{deep:!0})},500)}})})();
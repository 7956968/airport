function VSClientSession(t){this.connection=null,this.hasLogon=!1,this.context={},this.callback=t,this.videos=[]}function Player(t,e,i,s,n){this.isAudio=n||!1,this.frontId=e,this.channel=i,this.isPreview=s,this.stream=null,this.video=t,this.gotInitSeg=!1,this.segments=[],this.frames=[],this.seq=0,this.frameCnt=0,this.timestamps=[],this.startTime=0,this.isRecording=!1,this.recordFilenamePrefix="",this.initSeg=null,this.recordBuffers=[],this.recordFileName="",this.onStreamPlayState=null}function streamId(t,e,i,s){return t+":"+e+":"+i+":"+s}function getStream(t,e,i,s){var n=streamId(t,e,i,s),r=sAllStreams[n];if(!r){var o=null;o=s?vsclientSession.webSocketHost()+"/audio?session="+vsclientSession.context.session+"&front="+t+"&channel="+e:vsclientSession.webSocketHost()+"/video?session="+vsclientSession.context.session+"&front="+t+"&channel="+e+"&is_preview="+i,r=new VideoStream(o,n,vsclientSession.callback.onStreamPlayStatus),sAllStreams[n]=r,r.start()}return r}function VideoStream(t,e,i){this.streamId=e,this.url=t,this.sinks=[],this.stopped=!0,this.initSeg=null,this.segCnt=0,this.callback=i}const STREAM_PLAY_STATE_REQUESTTING=1,STREAM_PLAY_STATE_REQ_STREAM_SUCCESS=2,STREAM_PLAY_STATE_PLAY_STRAM_SUCCESS=3,STREAM_PLAY_STATE_PLAY_STRAM_FAILED=10;VSClientSession.prototype.webSocketHost=function(){return"ws://"+this.serverIP+":"+this.serverPort},VSClientSession.prototype.getWSURL=function(){return this.webSocketHost()+"/session?user="+this.username+"&password="+this.password},VSClientSession.prototype.connectToServer=function(){console.log("url:"+this.wsURL),this.connection=new WebSocket(this.wsURL),this.connection.binaryType="arraybuffer",this.connection.onopen=this.onConnectedToServer.bind(this),this.connection.onerror=this.onFailedToConnectToServer.bind(this),this.connection.onclose=this.onServerConnectionLost.bind(this),this.connection.onmessage=this.onRecvServerMessage.bind(this)},VSClientSession.prototype.login=function(t,e,i,s){this.username=t,this.password=e,this.serverIP=i,this.serverPort=s,this.context={},this.hasLogon=!1,this.wsURL=this.getWSURL(),this.connectToServer()},VSClientSession.prototype.onConnectedToServer=function(){},VSClientSession.prototype.onFailedToConnectToServer=function(){this.hasLogon=!1,this.onLoginFailed()},VSClientSession.prototype.onServerConnectionLost=function(){this.hasLogon=!1,this.callback.onServerConnectionLost()},VSClientSession.prototype.onRecvServerMessage=function(t){if(event.data instanceof ArrayBuffer);else if("string"==typeof event.data){t=JSON.parse(event.data);this.handleMessage(t)}},VSClientSession.prototype.handleMessage=function(t){const e=t.msg_type;if("client_events"!==e){if(this.hasLogon){if("client_event"===e)switch(t.info.type){case 1:this.hasLogon=!1,this.callback.onClientServerConnLost();break;case 3:this.onFrontOnOfflineEvent(t.info.data);break;case 4:this.onFrontGPSEvent(t.info.data)}}else if("login_result"===e){if("success"!=t.result)return void this.callback.onLoginFailed();if(void 0===t.info)return;this.onlogon(t.info)}}else{var i=this;t.events.forEach(function(t){i.handleMessage(t)})}},VSClientSession.prototype.onlogon=function(t){this.context=$.extend(this.context,t),this.token=this.context.token,this.username||(this.username=t.username),this.hasLogon=!0,this.callback.onlogon(t)},VSClientSession.prototype.onLoginFailed=function(t){this.callback.onLoginFailed(t)},VSClientSession.prototype.onFrontOnOfflineEvent=function(t){var e=t.front,i=this.findFrontByID(e);i&&(i.online=t.online)},VSClientSession.prototype.onFrontGPSEvent=function(t){if(this.hasLogon){var e=this.findFrontByID(t.front);e&&(e.gps=jQuery.extend({},t),e.online&&this.callback.onGpsData(e))}},VSClientSession.prototype.findFrontByID=function(t){var e=jQuery.grep(this.context.front,function(e){return e.id==t});return e&&0!=e.length?e[0]:null},VSClientSession.prototype.findFrontByName=function(t){var e=jQuery.grep(this.context.front,function(e){return e.name==t});return e&&0!=e.length?e[0]:null},VSClientSession.prototype.startPlay=function(t,e,i){var s=jQuery.grep(this.context.front,function(e){return e.name==t});if(!s||0==s.length)return!1;if(s=s[0],!s.online)return!1;var n={videoCtrl:i,player:new Player(i,s.id,e,!0,!1)};return this.videos.push(n),n.player.start(),n.player.setStreamPlayStatus(this.callback.onStreamPlayStatus),!0},VSClientSession.prototype.stopPlay=function(t){for(var e=this.videos.length,i=0;i<e;++i)if(this.videos[i].videoCtrl===t)return this.videos[i].player.stop(),void this.videos.splice(i,1)},window.MediaSource=window.MediaSource||window.WebKitMediaSource;var writeToFile=0;Player.prototype.setStreamPlayStatus=function(t){this.onStreamPlayState=t},Player.prototype.start=function(){if(window.MediaSource){this.gotInitSeg=!1,this.track=null,this.seq=0,this.segments=[],this.frames=[],this.frameCnt=0,this.timestamps=[],this.startTime=0;this.GetTrack=function(t){var e=discardEmulationPreventionBytes(t.subarray(5));this.track=readSequenceParameterSet(e),this.track.id=1,this.track.pixelRatio=[1,1],this.track.duration=0,this.track.type="video",this.track.fragmented=!0,this.track.baseMediaDecodeTime=0,this.track.sps=[t.subarray(4)]},this.getNalu=function(t){if(t.length<4)return null;for(var e=!1,i=0,s=t.byteLength,n=0;n<t.byteLength;++n)if(1===t[n]&&n>=3&&0===t[n-1]&&0===t[n-2]&&0===t[n-3]){if(e){s=n-3;break}e=!0,i=n-3}return e&&i!==s?t.subarray(i,s):null},this.parseFrame=function(t){for(var e=0,i=!1;e<t.byteLength;){var s=new Uint8Array(t,e,t.byteLength-e),n=this.getNalu(s);if(!n)return i;var r=new DataView(t,n.byteOffset,4);r.setUint32(0,n.byteLength-4,!1);var o=31&s[4];5==o&&(i=!0),7!=o||this.track||this.GetTrack(n),8==o&&this.track&&!this.track.pps&&(this.track.pps=[n.subarray(4)]),e+=n.byteLength}return i},this.getNewSegment=function(){var t;this.track.samples=[];var e=0,i=90*Math.floor((this.timestamps[this.timestamps.length-1]-this.timestamps[0])/(this.timestamps.length-1)),s=90*(this.timestamps[this.timestamps.length-1]-this.timestamps[0])-i*(this.timestamps.length-1);for(t=0;t<this.frames.length-1;++t)this.track.samples.push({duration:0==t?i+s:i,size:this.frames[t].byteLength,dataOffset:e,flags:{isLeading:0,dependsOn:0==t?2:1,isDependedOn:0,hasRedundancy:0,isNonSyncSample:0==t?0:1,degradationPriority:0},compositionTimeOffset:0}),e+=this.frames[t].byteLength;this.track.baseMediaDecodeTime=90*(this.timestamps[0]-this.startTime),this.track.duration=90*(this.timestamps[this.timestamps.length-1]-this.timestamps[0]);var n=moof(this.seq,[this.track]),r=new ArrayBuffer(e),o=new Uint8Array(r),a=0;for(t=0;t<this.frames.length-1;++t)o.set(new Uint8Array(this.frames[t]),a),a+=this.frames[t].byteLength;var h=mdat(o);this.seq+=1;var c=new Uint8Array(n.byteLength+h.byteLength);c.set(n),c.set(h,n.byteLength),this.segments.push(c.buffer),this.isRecording&&(this.recordBuffers.push(c.buffer),this.checkRecordBuffer()),this.frames=[this.frames[this.frames.length-1]],this.lastTime=this.timestamps[this.frames.length-2],this.timestamps=[this.timestamps[this.timestamps.length-1]]};this.processNewFrame=function(){if(this.segments.push(this.frames[0]),this.isRecording&&this.gotInitSeg&&(this.recordBuffers.push(this.frames[0]),this.checkRecordBuffer()),this.frames=[],this.gotInitSeg||(this.gotInitSeg=!0,this.initSeg=this.segments[0],this.playNextSegment()),this.segments.length>0){var t=this.video.buffered,e=this.video.currentTime;if(t&&0!=t.length&&e){var i=t.end(t.length-1),s=this.isAudio?1:4;i-e>s&&(this.isAudio?this.video.currentTime=i-.32:this.video.currentTime=i)}this.segments.length>1&&this.segments.pop()}this.segments.length>0&&this.playNextSegment()},this.checkRecordBuffer=function(){for(var t=0,e=0;e<this.recordBuffers.length;++e)t+=this.recordBuffers[e].byteLength;t>=16e6&&this.flushRecordFile()},this.flushRecordFile=function(){if(this.initSeg&&0!==this.recordBuffers.length){var t,e=this.initSeg.byteLength;for(t=0;t<this.recordBuffers.length;++t)e+=this.recordBuffers[t].byteLength;var i=new Uint8Array(e);i.set(new Uint8Array(this.initSeg),0);var s=this.initSeg.byteLength;for(t=0;t<this.recordBuffers.length;++t)i.set(new Uint8Array(this.recordBuffers[t]),s),s+=this.recordBuffers[t].byteLength;var n=new Blob([i],{type:"video/mp4"});if(window.navigator.msSaveBlob)window.navigator.msSaveBlob(n,this.recordFileName);else{var r=window.URL||window.webkitURL,o=r.createObjectURL(n),a=document.createElement("a");a.setAttribute("download",this.recordFileName),a.href=o,document.body.appendChild(a),window.requestAnimationFrame(function(){var t=new MouseEvent("click");a.dispatchEvent(t),document.body.removeChild(a)})}this.recordFileName=this.recordFilenamePrefix+"_"+nowTimeString()+".mp4",this.recordBuffers=[]}},this.startPlay(),this.onsocketopen&&this.onsocketopen(),this.stream=getStream(this.frontId,this.channel,this.isPreview,this.isAudio),this.stream.addStreamSink(this)}},Player.prototype.onGettingStream=function(){},Player.prototype.reset=function(){this.stream&&(this.stream.removeStreamSink(this),this.onStreamEnd()),this.startPlay(),this.stream=getStream(this.frontId,this.channel,this.isPreview,this.isAudio),this.stream.addStreamSink(this)},Player.prototype.onStreamError=function(){this.onStreamEnd(),this.stream&&(this.stream.removeStreamSink(this),this.stream=null),this.onStreamError&&this.onStreamError()},Player.prototype.onStreamEnd=function(){if(this.afterVideoDisplaying&&this.afterVideoDisplaying(),this.isRecording&&this.flushRecordFile(),this.gotInitSeg=!1,this.track=null,this.seq=0,this.segments=[],this.frames=[],this.frameCnt=0,this.mediaSource){this.mediaSource=null;try{this.video.pause()}catch(t){}try{this.video.src=null}catch(t){}}},Player.prototype.isPlaying=function(){return this.gotInitSeg},Player.prototype.onNewSegment=function(t){this.mediaSource&&(0===this.frameCnt&&this.beforeVideoDisplaying&&this.beforeVideoDisplaying(),this.frameCnt+=1,this.frames.push(t),this.processNewFrame())},Player.prototype.stop=function(){if(this.stream&&(this.stream.removeStreamSink(this),this.stream=null),this.isRecording&&this.stopRecording(),this.mediaSource){this.mediaSource=null,this.video.pause();try{this.video.src=""}catch(t){}}this.gotInitSeg=!1,this.segments=[],this.frames=[],this.frameCnt=0},Player.prototype.playNextSegment=function(){if(this.mediaSource){var t=this.mediaSource.videoSrcBuf;if(t&&!t.updating&&0!=this.segments.length){try{var e=t.buffered;if(e&&e.length>0){var i=e.length;i>1&&console.log("buffered ranges number "+i);var s=e.start(i-1),n=e.end(i-1);if(n-s>16)return void t.remove(s,n-4)}}catch(t){console.log(t)}try{t.appendBuffer(this.segments.shift())}catch(t){console.log(t),this.reset()}}}},Player.prototype.startPlay=function(){this.mediaSource=new window.MediaSource,this.video.src=window.URL.createObjectURL(this.mediaSource),this.video.autoplay=!0,this.video.play();var t=this;this.mediaSource.addEventListener("sourceopen",function(e){this.videoSrcBuf||(t.isAudio?this.videoSrcBuf=this.addSourceBuffer('audio/mp4; codecs="mp4a.40.2"'):this.videoSrcBuf=this.addSourceBuffer('video/mp4; codecs="avc1.42E01E"'),this.videoSrcBuf.mode="sequence",this.duration=1/0,this.videoSrcBuf.addEventListener("updateend",function(e){writeToFile||t.playNextSegment()}))})};var sAllStreams={};VideoStream.prototype.start=function(){this.stopped=!1,this.initSeg=null,this.currSeg=null,this.segCnt=0,this.error=!1,this.websockt=new WebSocket(this.url),this.websockt.binaryType="arraybuffer";var t=this;this.sinks.forEach(function(){this.onGettingStream()}),this.websockt.onopen=function(){t.callback&&t.callback(STREAM_PLAY_STATE_REQ_STREAM_SUCCESS)},this.websockt.onclose=function(){t.sinks.forEach(function(t){this.error?t.onStreamError():t.onStreamEnd()}),t.initSeg=null,t.currSeg=null,t.websockt=null,console.log("websocket closed ")},this.websockt.onerror=function(){console.log("websocket error "+this.readyState),this.error=!0},this.websockt.onmessage=function(e){e.data instanceof ArrayBuffer&&(t.initSeg?(t.segCnt+=1,t.currSeg=e.data):(t.callback&&t.callback(STREAM_PLAY_STATE_PLAY_STRAM_SUCCESS),t.initSeg=e.data),t.sinks.forEach(function(e){e.gotInitSeg||e.onNewSegment(t.initSeg),t.currSeg&&e.onNewSegment(t.currSeg)}))}},VideoStream.prototype.stop=function(){this.stopped=!0,this.websockt&&(this.websockt.close(),delete this.websockt)},VideoStream.prototype.addStreamSink=function(t){-1===this.sinks.indexOf(t)&&(this.sinks.push(t),this.stopped||(this.initSeg?(t.onNewSegment(this.initSeg),this.currSeg&&t.onNewSegment(this.currSeg)):t.onGettingStream()))},VideoStream.prototype.removeStreamSink=function(t){var e=this.sinks.indexOf(t);-1!==e&&(this.sinks.splice(e,1),0===this.sinks.length&&(this.stop(),delete sAllStreams[this.streamId]))};
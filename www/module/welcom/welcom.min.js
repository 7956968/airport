(function(){var e=utility.getLocalStorage("language"),t=utility.getLocalStorage("userInfo"),a=utility.getLocalStorage("bizParam"),i=(utility.getLocalStorage("airPort"),utility.getLocalStorage("userFuncList")),n=function(){var e={isViewVideo:!1,isSearch:!1,isTrack:!1,isOnlineDetail:!1};for(var t in i)if(i.hasOwnProperty(t))for(var a=0,n=i[t].length;a<n;a++)"device_manage_view_video"==i[t][a].functionCode&&(e.isViewVideo=!0),"map_query_live_vehicle"==i[t][a].functionCode&&(e.isSearch=!0),"map_view_track"==i[t][a].functionCode&&(e.isTrack=!0),"device_manage_secure_area"==i[t][a].functionCode&&(e.isDefense=!0),"device_manage_camera"==i[t][a].functionCode&&(e.isCamera=!0),"device_manage_view_online"==i[t][a].functionCode&&(e.isOnlineDetail=!0);return e}(),o=new Vue({el:"#js-vue",data:{isBaiYun:!0,functionInfo:n,language:e?e.language:"CN",isLoading:!0,innerHeight:window.innerHeight/2,resizeTime:null,copyRight:{CN:"@copyRight 深圳市民贵科技有限公司",EN:"@copyRight Mingui Non-Powered Euipment Management System",TW:"@copyRight 民貴無動力管理系統"}[e.language],vehicleInfo:{list:[],count:0},terminalStatusList:a.terminalStatus,vehicleTypeList:a.vehicleType,vehicleInfoStr:"",vehicleTypeInfo:{},vehiclePassType:{},isloadDefen:!1,totalChartData:null,colorList:["#66CCCC","#CCFF66","#FF99CC","#A0522D","#FFFF00","#336699","#CC9933","#339999"],statuPageInfo:{online:2,daySpan:0,pageNum:1,pageSize:10,count:0,vehicleStatus:"",licenseNumber:""},isTableLoading:!1,showStatuDetail:!1,statuItemInfo:{},statuColumns:[{title:"车牌号",key:"licenseNumber"},{title:"车辆名称",key:"vehicleName"},{title:"车辆状态",key:"vehicleStatusName",align:"center",filters:function(){for(var e=a.terminalStatus,t=[],i=0,n=e.length;i<n;i++)401!=e[i].type&&402!=e[i].type&&403!=e[i].type&&406!=e[i].type||t.push({label:e[i].name,value:e[i].type});return t}(),filterMultiple:!1,filterRemote(e,t){o.statuPageInfo.vehicleStatus=e,o.getStatuVehicleList(!0)}},{title:"最后上线时间",render:function(e,t){var a="normalDay",i=Date.parse(new Date);if(t.row.lastGpsTime){var n=Date.parse(t.row.lastOnlineTime.replace(/\-/g,"/")),o=Math.floor((i-n)/864e5);o>=7&&(a="overDay")}return e("div",[e("span",{class:a},t.row.lastOnlineTime)])}},{title:"操作",key:"operation",align:"center",render:function(e,t){var a="primary",i="详情";return 1==t.row.alarmFlag&&(a="error",i="异常"),e("div",[e("Button",{props:{type:a,size:"small"},style:{marginRight:"5px"},on:{click:function(){o.showStatuDetail=!0,o.statuItemInfo=o.statuDataList[t.index],o.statuItemInfo.lastPosition="null"!=o.statuItemInfo.lastPosition?JSON.parse(o.statuItemInfo.lastPosition).coordinates.join(","):null;var e=Date.parse(new Date),a=Date.parse(t.row.lastGpsTime.replace(/\-/g,"/")),i=Math.floor((e-a)/864e5);i>=1&&(o.statuItemInfo.overDay=!0),1==t.row.alarmFlag&&(o.alarmPageInfo.companyId=o.statuItemInfo.companyId,o.alarmPageInfo.deptId=o.statuItemInfo.deptId,o.alarmPageInfo.vehicleName=o.statuItemInfo.vehicleName,o.alarmPageInfo.licenseNumber=o.statuItemInfo.licenseNumber,o.getAlarmList(!0))}}},i),e("Button",{props:{icon:"md-pin",type:"warning",size:"small"},on:{click:function(){o.toMapCoordinates(o.statuDataList[t.index])}}},"")])}}],statuDataList:[],isloadStae:!1,onlineStatPageInfo:{count:0,pageNum:1,pageSize:10,beginTime:"",endTime:"",licenseNumber:""},onlineStatColumns:[{title:"车牌号",width:100,key:"licenseNumber"},{title:"统计日期",key:"statDay",sortable:!0,sortType:"asc"},{title:"在线次数",key:"onlineCount",sortable:!0,align:"center"},{title:"在线时长",key:"onlineDuration",sortable:!0,align:"center",render:function(e,t){var a=(t.row.onlineDuration/3600).toFixed(2)+"小时";return e("div",[e("span",{},a)])}},{title:"操作",key:"operation",align:"center",render:function(t,a){return t("div",[t("Button",{props:{type:"primary",size:"small"},on:{click:function(){o.showOnlineDetail=!0,o.onlineStatItemInfo=o.onlineStatList[a.index]}}},{CN:"详情",EN:"Detail",TW:"詳情"}[e.language])])}}],onlineStatList:[],onlineStatItemInfo:{},showOnlineDetail:!1,current:1,alarmPageInfo:{count:0,companyId:"",deptId:"",dealFlag:0,vehicleName:"",licenseNumber:"",pageSize:20,pageNum:1},alarmColumnsList:[{title:"警报事件",key:"eventTypeDesc",width:100,render:function(e,t){var a={_1:"拆卸",_2:"超速",_3:"电量低",_4:"硬盘故障",_501:"进入防区",_502:"离开防区",_503:"防区内停留",_504:"防区内行驶",_505:"防区内超速"};return e("div",[e("span",{},t.row.eventTypeDesc||a["_"+t.row.eventTypeId])])}},{title:"报警时间",key:"alarmTime",width:140},{title:"报警内容",key:"alarmInfo"},{title:"操作",key:"operation",align:"center",width:140,render:function(e,t){return e("div",[e("Button",{props:{type:"primary",size:"small"},style:{marginRight:"5px"},on:{click:function(){o.toAlarmPage(o.statuItemInfo)}}},"详情"),e("Button",{props:{type:"warning",size:"small"},on:{click:function(){o.editItem(t.index)}}},"处理异常")])}}],alarmRowList:[],isAlarmShowModal:!1,isAlarmModalLoading:!0,alarmItemInfo:{id:"",dealFlag:"",remark:"",createUserId:t.id,modifyUserId:t.id},vehicleCateReport:[]},methods:{isLogin:function(){t||(alert("请先登录！"),window.parent.window.location.href="/airport/www/login.html")},setTotalEchart:function(){var e=this,t=echarts.init(document.getElementById("totalEchart")),a=[],i=[],n=[],o=e.totalChartData.reverse();for(var l in e.vehicleTypeInfo){e.vehicleTypeInfo[l].list=new Array(e.totalChartData.length);for(var r=0,c=e.totalChartData.length;r<c;r++)e.vehicleTypeInfo[l].list[r]=0}for(var s=0,u=o.length;s<u;s++){a.push(o[s].day);for(var d=0,m=o[s].useStat.length;d<m;d++)o[s].useStat[d].vehicleTypeId&&e.vehicleTypeInfo["_"+o[s].useStat[d].vehicleTypeId]&&(e.vehicleTypeInfo["_"+o[s].useStat[d].vehicleTypeId].list[s]=o[s].useStat[d].totalVehicleNum)}for(var l in e.vehicleTypeInfo)n.push(e.vehicleTypeInfo[l].name),e.vehicleTypeInfo.hasOwnProperty(l)&&i.push({name:e.vehicleTypeInfo[l].name,type:"bar",barWidth:4,itemStyle:{normal:{barBorderRadius:2,color:e.vehicleTypeInfo[l].color}},data:e.vehicleTypeInfo[l].list});option={backgroundColor:"#0f375f",tooltip:{trigger:"axis",axisPointer:{type:"shadow"}},legend:{left:20,right:10,top:5,padding:[5,2],itemWidth:15,itemGap:5,data:n,textStyle:{color:"#ccc"}},grid:{left:40,top:80,right:50,bottom:40},xAxis:{name:"日期",data:a,axisLine:{lineStyle:{color:"#ccc"}}},yAxis:{name:"单位:辆",minInterval:1,splitLine:{show:!1},axisLine:{lineStyle:{color:"#ccc"}}},series:i.reverse()},t.setOption(option)},setVehicleEchart:function(){var e=this,t=[],a=[],i=echarts.init(document.getElementById("totalEchart"));for(var n in e.vehicleTypeInfo)a.push(e.vehicleTypeInfo[n].name),t.push({value:0,itemStyle:{color:e.vehicleTypeInfo[n].color},label:{normal:{show:!0,position:"top",fontSize:14}}});for(var o=0,l=a.length;o<l;o++)for(var r=0,c=e.vehicleCateReport.length;r<c;r++)(function(i){a[i]==e.vehicleCateReport[r].vehicleTypeName&&(t[i].value=t[i].value+e.vehicleCateReport[r].totalVehicleNum)})(o);var s={tooltip:{trigger:"axis",axisPointer:{type:"shadow"}},grid:{left:40,top:40,right:70,bottom:60},xAxis:{name:"车辆类型",type:"category",data:a,axisLabel:{interval:0,rotate:30},axisLine:{lineStyle:{color:"#ccc"}}},yAxis:{name:"单位:辆",minInterval:1,splitLine:{show:!1},axisLine:{lineStyle:{color:"#ccc"}}},series:[{name:"车辆类型",type:"bar",barWidth:"60%",data:t}]};i.setOption(s)},resetVehicleBizParamInfo:function(){var e=this,t=[];e.vehicleTypeInfo={},e.vehiclePassType={},e.vehicleInfo={list:[],count:0};for(var a=0,i=e.vehicleTypeList.length;a<i;a++)302!=e.vehicleTypeList[a].type&&303!=e.vehicleTypeList[a].type&&109!=e.vehicleTypeList[a].type&&111!=e.vehicleTypeList[a].type&&112!=e.vehicleTypeList[a].type&&(e.vehicleTypeInfo["_"+e.vehicleTypeList[a].type]={value:0,name:e.vehicleTypeList[a].name,list:[],color:e.colorList[a]}),t.push(e.vehicleTypeList[a].type);e.vehicleInfoStr=t.join();for(var n=0,o=e.terminalStatusList.length;n<o;n++)e.vehicleInfo["_"+e.terminalStatusList[n].type]=0},startDateChange:function(e){var t=this;t.onlineStatPageInfo.beginTime=e,t.getVehicleOnlineStat(!1)},endDateChange:function(e){var t=this;t.onlineStatPageInfo.endTime=e,t.getVehicleOnlineStat(!1)},onlineStatPageSizeChange:function(e){var t=this;t.onlineStatPageInfo.pageNum=parseInt(e,10),setTimeout(function(){t.getVehicleOnlineStat(!1)},200)},onlineStatPageRowChange:function(e){var t=this;t.onlineStatPageInfo.pageSize=parseInt(e,10),setTimeout(function(){t.getVehicleOnlineStat(!1)},200)},getVehicleOnlineStat:function(e){var t=this;1==e&&(t.onlineStatPageInfo.pageNum=1),utility.interactWithServer({url:CONFIG.HOST+CONFIG.SERVICE.vehicleService+"?action="+CONFIG.ACTION.getVehicleOnlineStat,actionUrl:CONFIG.SERVICE.vehicleService,dataObj:{pageNum:t.onlineStatPageInfo.pageNum,pageSize:t.onlineStatPageInfo.pageSize,beginTime:t.onlineStatPageInfo.beginTime,endTime:t.onlineStatPageInfo.endTime,licenseNumber:encodeURI($.trim(t.onlineStatPageInfo.licenseNumber))},beforeSendCallback:function(){t.isloadStae=!0},completeCallback:function(){t.isloadStae=!1},successCallback:function(e){200==e.code&&(t.onlineStatPageInfo.count=e.count,t.onlineStatList=e.data)}})},getAllVehicleList:function(){var e=this;utility.interactWithServer({url:CONFIG.HOST+CONFIG.SERVICE.vehicleService+"?action="+CONFIG.ACTION.getVehicleList,actionUrl:CONFIG.SERVICE.vehicleService,dataObj:{id:"",pageSize:1e4},successCallback:function(t){if(200==t.code){e.vehicleInfo.count=t.count,e.vehicleInfo.list=t.data;for(var a=0,i=e.vehicleInfo.list.length;a<i;a++)e.vehicleInfo["_"+e.vehicleInfo.list[a].vehicleStatus]=e.vehicleInfo["_"+e.vehicleInfo.list[a].vehicleStatus]+1,e.vehicleTypeInfo["_"+e.vehicleInfo.list[a].vehicleTypeId]&&(e.vehicleTypeInfo["_"+e.vehicleInfo.list[a].vehicleTypeId].value=e.vehicleTypeInfo["_"+e.vehicleInfo.list[a].vehicleTypeId].value+1)}}})},statuPageSizeChange:function(e){var t=this;t.current=e,t.statuPageInfo.pageNum=parseInt(e,10),setTimeout(function(){t.getStatuVehicleList(!1)},200)},statuPageRowChange:function(e){var t=this;t.statuPageInfo.pageSize=parseInt(e,10),setTimeout(function(){t.getStatuVehicleList(!1)},200)},getStatuVehicleList:function(e){var t=this;1==e&&(t.current=1,t.statuPageInfo.pageNum=1),utility.interactWithServer({url:CONFIG.HOST+CONFIG.SERVICE.vehicleService+"?action="+CONFIG.ACTION.getVehicleList,actionUrl:CONFIG.SERVICE.vehicleService,dataObj:{id:"",online:parseInt(t.statuPageInfo.online),daySpan:parseInt(t.statuPageInfo.daySpan),pageSize:t.statuPageInfo.pageSize,vehicleStatus:t.statuPageInfo.vehicleStatus,pageNum:t.statuPageInfo.pageNum,licenseNumber:encodeURI($.trim(t.statuPageInfo.licenseNumber))},beforeSendCallback:function(){t.isTableLoading=!0},completeCallback:function(){t.isTableLoading=!1},successCallback:function(e){if(200==e.code){var a=[];t.statuPageInfo.count=e.count;for(var i=0,n=e.data.length;i<n;i++)a.push({alarmFlag:decodeURI(e.data[i].alarmFlag),companyName:decodeURI(e.data[i].companyName),deptName:decodeURI(e.data[i].deptName),vehicleName:decodeURI(e.data[i].vehicleName),licenseNumber:decodeURI(e.data[i].licenseNumber),vehicleCode:decodeURI(e.data[i].vehicleCode),lastGpsTime:decodeURI(e.data[i].lastGpsTime),lastOnlineTime:decodeURI(e.data[i].lastOnlineTime),lastPosition:decodeURI(e.data[i].lastPosition),useStatusName:decodeURI(e.data[i].useStatusName),providerName:decodeURI(e.data[i].providerName),gpsDeviceCode:decodeURI(e.data[i].gpsDeviceCode),lastAddress:"",vehicleStatusName:decodeURI(e.data[i].vehicleStatusName),cellClassName:{vehicleStatusName:"_"+e.data[i].vehicleStatus}});t.statuDataList=a}}})},toMapPage:function(e){utility.setSessionStorage("vehicleInfoFrom",null),utility.setSessionStorage("fromInfo",{type:"isSearch",vehicleStatus:e}),setTimeout(function(){$(window.parent.document).find("#nav_Maps").bind("click"),$(window.parent.document).find("#nav_Maps").trigger("click")},200)},getVehicleStatusReport:function(){utility.interactWithServer({url:CONFIG.HOST+CONFIG.SERVICE.vehicleService+"?action="+CONFIG.ACTION.getVehicleStatusReport,actionUrl:CONFIG.SERVICE.getVehicleStatusReport,successCallback:function(e){e.code}})},getVehicleRunReport:function(){var e=this;utility.interactWithServer({url:CONFIG.HOST+CONFIG.SERVICE.vehicleService+"?action="+CONFIG.ACTION.getVehicleRunReport,actionUrl:CONFIG.SERVICE.getVehicleRunReport,successCallback:function(t){200==t.code&&(e.totalChartData=t.data,e.setTotalEchart())}})},getVehicleCateReport:function(){var e=this;utility.interactWithServer({url:CONFIG.HOST+CONFIG.SERVICE.vehicleService+"?action="+CONFIG.ACTION.getVehicleCateReport,actionUrl:CONFIG.SERVICE.getVehicleCateReport,successCallback:function(t){200==t.code&&(e.vehicleCateReport=t.data,e.setVehicleEchart())}})},toOnlineDetail:function(e){utility.setSessionStorage("onlineStatItemInfo",e),setTimeout(function(){$(window.parent.document).find("#nav_OnlineDetail").bind("click"),$(window.parent.document).find("#nav_OnlineDetail").trigger("click")},200)},alarmPageSizeChange:function(e){var t=this;t.alarmPageInfo.pageNum=parseInt(e,10),setTimeout(function(){t.getAlarmList(!1)},200)},alarmPageRowChange:function(e){var t=this;t.alarmPageInfo.pageSize=parseInt(e,10),setTimeout(function(){t.getAlarmList(!1)},200)},toAlarmPage:function(e){utility.setSessionStorage("fromMap",e),setTimeout(function(){$(window.parent.document).find("#nav_Alarm").bind("click"),$(window.parent.document).find("#nav_Alarm").trigger("click")},200)},editItem:function(e){var t=this;t.isAlarmShowModal=!0,t.alarmItemInfo=t.alarmRowList[e]},uploadDataToServer:function(){var e=this;utility.interactWithServer({url:CONFIG.HOST+CONFIG.SERVICE.alarmService+"?action="+CONFIG.ACTION.updateAlarmStatus,actionUrl:CONFIG.SERVICE.alarmService,dataObj:{id:e.alarmItemInfo.id,createUserId:t.id,modifyUserId:t.id,dealFlag:e.alarmItemInfo.dealFlag,remark:encodeURI(e.alarmItemInfo.remark)},completeCallback:function(){e.isAlarmModalLoading=!1},successCallback:function(t){200==t.code?(e.getAlarmList(!0),e.isAlarmShowModal=!1):e.$Message.error(t.message)}})},getAlarmList:function(e){var t=this;t.alarmRowList=[],1==e&&(t.alarmPageInfo.pageNum=1),utility.interactWithServer({url:CONFIG.HOST+CONFIG.SERVICE.alarmService+"?action="+CONFIG.ACTION.getAlarmList,actionUrl:CONFIG.SERVICE.alarmService,dataObj:{pageNum:t.alarmPageInfo.pageNum,pageSize:t.alarmPageInfo.pageSize,dealFlag:t.alarmPageInfo.dealFlag,vehicleName:encodeURI(t.alarmPageInfo.vehicleName),companyId:t.alarmPageInfo.companyId,deptId:t.alarmPageInfo.deptId},successCallback:function(e){if(200==e.code){var a=[];t.alarmPageInfo.count=e.count;for(var i=0,n=e.data.length;i<n;i++)a.push(e.data[i]),a[i].alarmAddress="";t.alarmRowList=a;for(var o=0;o<e.data.length;o++)(function(a){if(e.data[a].lastPosition){var i=JSON.parse(e.data[a].lastPosition).coordinates;0!=i[0]&&0!=i[1]?utility.convertorByBaidu(i,gcoord,BMap,function(e,i,n){utility.getAdressDetail([i,n],BMap,function(e){t.alarmRowList[a].alarmAddress=e})}):t.alarmRowList[a].alarmAddress="--"}else t.alarmRowList[a].alarmAddress="--"})(o)}}})},toMapCoordinates:function(e){utility.setSessionStorage("fromInfo",null),utility.setSessionStorage("vehicleInfoFrom",e),setTimeout(function(){$(window.parent.document).find("#nav_Maps").bind("click"),$(window.parent.document).find("#nav_Maps").trigger("click")},200)},init:function(){var e=this;e.resetVehicleBizParamInfo(),e.getAllVehicleList(),e.getStatuVehicleList(),e.getVehicleOnlineStat(!0),e.getVehicleCateReport()}},created:function(){var e=this;utility.isLogin(!1),e.init(),setInterval(function(){e.init()},1e4),$(window).resize(function(){clearTimeout(e.resizeTime),e.resizeTime=setTimeout(function(){window.location.href=window.location.href},500)})},mounted:function(){var e=this;setTimeout(function(){e.isLoading=!1},5e3)}})})();
(function(){var e,i=utility.getLocalStorage("language"),t=utility.getLocalStorage("userInfo"),a=utility.getLocalStorage("bizParam"),n=utility.getLocalStorage("userFuncList").menu_device,l=function(){for(var e=!1,i=0,t=n.length;i<t;i++)if("device_manage_view_video"==n[i].functionCode){e=!0;break}return e}(),c=[],o=[],s=new Vue({el:"#js-vue",data:{language:i?i.language:"CN",isTableLoading:!0,isShowModal:!1,isShowDetail:!1,isShowTerminal:!1,isModalLoading:!0,isDelete:!1,modalTitle:"",tableHeight:(e=$(".tableContainer").height(),e-100),vehicleColorList:a.vehicleColor,vehicleTypeList:a.vehicleType,vehicleBrandList:a.vehicleBrand,vehicleStatuList:a.terminalStatus,vehicleUseStatusList:a.vehicleUseStatus,deviceProviderIdList:a.deviceProviderId,index:0,selectItem:null,vehicleInfo:{list:[],count:0,_401:0,_402:0,_406:0},itemInfo:{id:"",companyId:"",companyName:"",vehicleName:"",vehicleCode:"",useStatus:"",remark:"",providerId:"",vehicleColorId:"",vehicleTypeId:"",vehicleBrandId:"",deptId:"",deptIds:[],deptName:"",gpsDeviceId:"",gpsDeviceCode:"",vehicleStatus:""},pageInfo:{count:0,companyId:"",deptId:"",deptIds:[],bindDeviceFlag:"",vehicleName:"",vehicleCode:"",licenseNumber:"",vehicleStatus:"",useStatus:"-1",gpsDeviceId:"",vehicleColorId:"",vehicleTypeId:"",vehicleBrandId:"",createUserId:t.id,modifyUserId:t.id},page:{pageSize:20,pageNum:1},vehicleList:[],columnsList:[{type:"index",width:60,align:"center",title:"序号",fixed:"left"},{title:"公司",key:"companyId",fixed:"left",width:200,filters:c,filterMultiple:!1,filterRemote(e,i){s.pageInfo.companyId=e,s.getDepartmentList()}},{title:"部门",key:"deptId",width:180,fixed:"left",filters:o,filterMultiple:!1,filterRemote(e,i){s.pageInfo.deptIds=e}},{title:"车辆名称",key:"vehicleName",width:150},{title:"车牌号",key:"licenseNumber",width:140},{title:"运动状态",key:"vehicleStatus",width:l?240:120,filters:function(){for(var e=[],i=a.terminalStatus,t=0,n=i.length;t<n;t++)401!=i[t].type&&402!=i[t].type&&403!=i[t].type&&406!=i[t].type||e.push({label:i[t].name,value:i[t].type});return e}(),filterMultiple:!1,filterRemote(e,i){s.pageInfo.vehicleStatus=e},render:function(e,i){var t=null,a=null;return l&&s.vehicleList[i.index]&&s.vehicleList[i.index].licenseNumber&&s.vehicleList[i.index].providerId<100&&(401==s.vehicleList[i.index].vehicleStatus||402==s.vehicleList[i.index].vehicleStatus?(t=e("Button",{props:{type:"primary",size:"small"},style:{marginLeft:"5px"},on:{click:function(){s.showLiveVideo(s.vehicleList[i.index],0)}}},"实时监控"),a=2==s.vehicleList[i.index].providerId?e("Button",{props:{type:"default",size:"small",disabled:!0},class:"disabled",style:{marginLeft:"5px"}},"视频回放"):e("Button",{props:{size:"small"},class:"backPlay",style:{marginLeft:"5px"},on:{click:function(){s.showLiveVideo(s.vehicleList[i.index],1)}}},"视频回放")):(t=e("Button",{props:{type:"default",size:"small",disabled:!0},class:"disabled",style:{marginLeft:"5px"}},"实时监控"),a=e("Button",{props:{type:"default",size:"small",disabled:!0},class:"disabled",style:{marginLeft:"5px"}},"视频回放"))),e("div",[e("span",{props:{type:"warning",size:"small"},style:{marginRight:"5px"}},i.row.vehicleStatus),t,a])}},{title:"上下线明细",width:100,render:function(e,i){return e("div",[e("Button",{props:{type:"default",size:"small"},style:{marginLeft:"5px"},on:{click:function(){s.toOnlineDetail(i.row)}}},"查看明细")])}},{title:"车辆编码",key:"vehicleCode",width:150},{title:"绑定终端",key:"gpsDeviceId",width:250},{title:"车辆类型",key:"vehicleTypeId",width:120},{title:"品牌",key:"vehicleBrandId",width:120},{title:"操作",key:"operation",fixed:"right",align:"center",width:200,render:function(e,i){return e("div",[e("Button",{props:{icon:"md-pin",type:"info",size:"small"},style:{marginRight:"5px"},on:{click:function(){s.toMapCoordinates(s.vehicleList[i.index])}}},""),e("Button",{props:{size:"small"},style:{marginRight:"5px"},on:{click:function(){s.index=i.index,s.selectItem=i.row,s.showDetail()}}},"详情"),e("Button",{props:{type:"warning",size:"small"},style:{marginRight:"5px"},on:{click:function(){s.index=i.index,s.selectItem=i.row,s.editItem()}}},"编辑"),e("Button",{props:{type:"error",size:"small"},style:{marginRight:"5px"},on:{click:function(){s.index=i.index,s.selectItem=i.row,s.itemInfo=s.vehicleList[s.index],s.isDelete=!0}}},"删除")])}}],dataList:[],companyList:[],filterCompany:[],departmentList:[],terminalList:[],isRecord:!1,recordIndex:0,recordPageInfo:{count:0,pageSize:20,pageNum:0,vehicleId:""},userRecordcolumns:[{title:"运动状态",key:"vehicleStatusName"},{title:"开始使用时间",key:"lastCreateTime",width:150},{title:"结束使用时间",key:"lastFinishTime",width:150}],userRecordList:[]},methods:{refresh:function(){window.location.href=window.location.href},addItem:function(){var e=this;e.isShowModal=!0,e.isModalLoading=!0,e.modalTitle={CN:"新增",EN:"Add",TW:"新增"}[e.language],e.itemInfo={id:"",companyId:"",companyName:"",vehicleName:"",vehicleCode:"",useStatus:"",remark:"",vehicleColorId:"",vehicleTypeId:"",vehicleBrandId:"",deptIds:[],deptName:"",gpsDeviceId:"",gpsDeviceCode:"",vehicleStatus:"",createUserId:t.id,modifyUserId:t.id}},editItem:function(){var e=this;utility.showMessageTip(e,function(){e.itemInfo=e.vehicleList[e.index],e.isShowModal=!0,e.modalTitle={CN:"修改",EN:"Edit",TW:"修改"}[e.language],e.getDepartmentTreeList("itemInfo")})},showDetail:function(){var e=this;utility.showMessageTip(e,function(){e.itemInfo=e.vehicleList[e.index],e.itemInfo.deptId=[e.vehicleList[e.index].deptId],e.isShowDetail=!0})},delItem:function(){var e=this;e.itemInfo=e.vehicleList[e.index],utility.showMessageTip(e,function(){utility.interactWithServer({url:CONFIG.HOST+CONFIG.SERVICE.vehicleService+"?action="+CONFIG.ACTION.delVehicle+"&ids="+e.itemInfo.id+"&modifyUserId="+t.id,actionUrl:CONFIG.SERVICE.vehicleService,beforeSendCallback:function(){e.isModalLoading=!0},completeCallback:function(){e.isModalLoading=!1},successCallback:function(i){200==i.code?(e.isDelete=!1,e.getVehicleList(!1)):e.$Message.error(i.message)}})})},pageSizeChange:function(e){var i=this;i.page.pageNum=parseInt(e,10),setTimeout(function(){i.getVehicleList(!1)},200)},pageRowChange:function(e){var i=this;i.page.pageSize=parseInt(e,10),setTimeout(function(){i.getVehicleList(!1)},200)},setCurrentRowData:function(e,i){var t=this;t.index=i,t.selectItem=e},toOnlineDetail:function(e){utility.setSessionStorage("onlineStatItemInfo",e),setTimeout(function(){$(window.parent.document).find("#nav_OnlineDetail").bind("click"),$(window.parent.document).find("#nav_OnlineDetail").trigger("click")},200)},vehicleUseStatusChange:function(e,i){var t=this;t.itemInfo=t.vehicleList[i],t.itemInfo.useStatus=t.dataList[i].useStatus,t.uploadDataToServer()},uploadDataToServer:function(){var e=this;utility.interactWithServer({url:CONFIG.HOST+CONFIG.SERVICE.vehicleService+"?action="+CONFIG.ACTION.saveVehicle,actionUrl:CONFIG.SERVICE.vehicleService,dataObj:{id:e.itemInfo.id,companyId:e.itemInfo.companyId,deptId:e.itemInfo.deptIds?e.itemInfo.deptIds[e.itemInfo.deptIds.length-1]:e.itemInfo.deptId,vehicleName:encodeURI($.trim(e.itemInfo.vehicleName)),vehicleCode:encodeURI($.trim(e.itemInfo.vehicleCode)),licenseNumber:encodeURI($.trim(e.itemInfo.licenseNumber)),gpsDeviceId:e.itemInfo.gpsDeviceId,useStatus:e.itemInfo.useStatus,vehicleColorId:e.itemInfo.vehicleColorId,vehicleTypeId:e.itemInfo.vehicleTypeId,vehicleBrandId:e.itemInfo.vehicleBrandId,providerId:e.itemInfo.providerId,remark:encodeURI($.trim(e.itemInfo.remark)),createUserId:t.id,modifyUserId:t.id},completeCallback:function(){e.isModalLoading=!1},successCallback:function(i){200==i.code?(e.getVehicleList(!1),e.isShowModal=!1):e.$Message.error(i.message)}})},formatVehicle:function(){for(var e=this,i=0,t=e.vehicleList.length;i<t;i++)e.dataList.push({companyId:e.vehicleList[i].companyName,deptId:e.vehicleList[i].deptName,vehicleName:decodeURI(e.vehicleList[i].vehicleName),vehicleCode:decodeURI(e.vehicleList[i].vehicleCode),licenseNumber:decodeURI(e.vehicleList[i].licenseNumber||""),gpsDeviceId:e.vehicleList[i].gpsDeviceCode,useStatus:e.vehicleList[i].useStatusName,vehicleColorId:function(){for(var t="",a=0,n=e.vehicleColorList.length;a<n;a++)if(e.vehicleList[i].vehicleColorId==e.vehicleColorList[a].type){t=e.vehicleColorList[a].name;break}return t}(),vehicleTypeId:function(){for(var t="",a=0,n=e.vehicleTypeList.length;a<n;a++)if(e.vehicleList[i].vehicleTypeId==e.vehicleTypeList[a].type){t=e.vehicleTypeList[a].name;break}return t}(),vehicleBrandId:function(){for(var t="",a=0,n=e.vehicleBrandList.length;a<n;a++)if(e.vehicleList[i].vehicleBrandId==e.vehicleBrandList[a].type){t=e.vehicleBrandList[a].name;break}return t}(),vehicleStatus:e.vehicleList[i].vehicleStatusName,cellClassName:{vehicleStatus:"_"+e.vehicleList[i].vehicleStatus}})},getVehicleList:function(e){var i=this;i.vehicleList=[],1==e&&(i.pageInfo.pageNum=1),utility.interactWithServer({url:CONFIG.HOST+CONFIG.SERVICE.vehicleService+"?action="+CONFIG.ACTION.getVehicleList,actionUrl:CONFIG.SERVICE.vehicleService,dataObj:{createUserId:t.id,modifyUserId:t.id,pageNum:i.page.pageNum,pageSize:i.page.pageSize,companyId:i.pageInfo.companyId,vehicleTypeId:i.pageInfo.vehicleTypeId,vehicleStatus:i.pageInfo.vehicleStatus,useStatus:i.pageInfo.useStatus,bindDeviceFlag:i.pageInfo.bindDeviceFlag,vehicleColorId:i.pageInfo.vehicleColorId,vehicleBrandId:i.pageInfo.vehicleBrandId,vehicleName:encodeURI($.trim(i.pageInfo.vehicleName)),vehicleCode:encodeURI($.trim(i.pageInfo.vehicleCode)),gpsDeviceId:encodeURI(i.pageInfo.gpsDeviceId),licenseNumber:encodeURI($.trim(i.pageInfo.licenseNumber)),deptId:i.pageInfo.deptIds[i.pageInfo.deptIds.length-1]||0},beforeSendCallback:function(){},completeCallback:function(){i.isTableLoading=!1},successCallback:function(e){200==e.code&&(i.dataList=[],i.vehicleList=e.data.sort(function(e,i){return e.vehicleStatus-i.vehicleStatus}),i.pageInfo.count=e.count,i.formatVehicle())}})},getAllVehicleList:function(){var e=this;e.vehicleInfo={list:[],count:0,_401:0,_402:0,_406:0},utility.interactWithServer({url:CONFIG.HOST+CONFIG.SERVICE.vehicleService+"?action="+CONFIG.ACTION.getVehicleList,actionUrl:CONFIG.SERVICE.vehicleService,dataObj:{id:"",pageSize:1e4},successCallback:function(i){if(200==i.code){e.vehicleInfo.count=i.count,e.vehicleInfo.list=i.data;for(var t=0,a=e.vehicleInfo.list.length;t<a;t++)401!=e.vehicleInfo.list[t].vehicleStatus&&402!=e.vehicleInfo.list[t].vehicleStatus&&406!=e.vehicleInfo.list[t].vehicleStatus||(e.vehicleInfo["_"+e.vehicleInfo.list[t].vehicleStatus]=e.vehicleInfo["_"+e.vehicleInfo.list[t].vehicleStatus]+1)}}})},getCompanyList:function(){var e=this;utility.interactWithServer({url:CONFIG.HOST+CONFIG.SERVICE.companyService+"?action="+CONFIG.ACTION.getCompanyList,actionUrl:CONFIG.SERVICE.companyService,dataObj:{id:0,pageSize:1e4},successCallback:function(i){if(200==i.code){e.companyList=i.data;for(var t=0,a=e.companyList.length;t<a;t++)c.push({label:e.companyList[t].companyName,value:e.companyList[t].id})}}})},getTerminalList:function(){var e=this;utility.interactWithServer({url:CONFIG.HOST+CONFIG.SERVICE.deviceService+"?action="+CONFIG.ACTION.getDeviceList,actionUrl:CONFIG.SERVICE.deviceService,dataObj:{id:0,pageSize:1e4},successCallback:function(i){200==i.code&&(e.terminalList=i.data)}})},getSuper:function(e,i,t){for(var a=this,n=0,l=e.length;n<l;n++)if(e[n].value==i){if(t.push(i),0==e[n].paraDeptId)return;a.getSuper(a.departmentList,e[n].paraDeptId,t)}else a.getSuper(e[n].children,i,t)},formatSuperiorDeprt:function(e){var i=this,t=JSON.stringify(e).replace(/id/g,"value").replace(/deptName/g,"label").replace(/subDeptList/g,"children");i.departmentList=JSON.parse(t)},getDepartmentTreeList:function(e){var i=this;i.departmentList=[],utility.interactWithServer({url:CONFIG.HOST+CONFIG.SERVICE.deptService+"?action="+CONFIG.ACTION.getDeptTreeList,actionUrl:CONFIG.SERVICE.deptService,dataObj:{id:0,pageSize:1e4,companyId:i[e].companyId||0},successCallback:function(t){if(200==t.code){var a=[];i[e].deptIds=[],i.formatSuperiorDeprt(t.data),i.getSuper(i.departmentList,i[e].deptId,a),i[e].deptIds=a.reverse()}}})},getDepartmentList:function(){var e=this;utility.interactWithServer({url:CONFIG.HOST+CONFIG.SERVICE.deptService+"?action="+CONFIG.ACTION.getDeptList,actionUrl:CONFIG.SERVICE.deptService,dataObj:{pageNum:1,pageSize:1e4,companyId:e.pageInfo.companyId[0]||0},successCallback:function(e){if(200==e.code)for(var i=0,t=e.data.length;i<t;i++)o.push({label:e.data[i].deptName,value:e.data[i].id})}})},showLiveVideo:function(e,i){var a="8080",n="http://43.247.68.26:"+a+"/airport/www/module/liveVideo/liveVideo.html?vehicleInfo="+encodeURI(JSON.stringify(e))+"&isBackPlay="+i;i&&(n="http://43.247.68.26:"+a+"/airport/www/module/playBack/liveVideo.html?vehicleInfo="+encodeURI(JSON.stringify(e))+"&isBackPlay="+i),2==e.providerId&&(n=i?"http://43.247.68.26:"+a+"/airport/www/module/playBack/liveVideo.html?vehicleInfo="+encodeURI(JSON.stringify(e))+"&isBackPlay="+i:"http://43.247.68.26:"+a+"/airport/www/module/liveVideoTest1/liveVideo.html?vehicleInfo="+encodeURI(JSON.stringify(e))+"&id="+t.id+"&userToken="+t.userToken+"&isBackPlay="+i),window.open(n,"liveVideo","toolbar=yes, location=0, directories=no, status=0, menubar=0, scrollbars=1, resizable=1, copyhistory=1, width="+window.outerWidth+", height="+(window.outerHeight-50))},userStatuPageSizeChange:function(e){var i=this;i.recordPageInfo.pageNum=parseInt(e,10),setTimeout(function(){i.getVehicleUseRecordList(!1)},200)},userStatuPageRowChange:function(e){var i=this;i.recordPageInfo.pageSize=parseInt(e,10),setTimeout(function(){i.getVehicleUseRecordList(!1)},200)},formatRecord:function(e){for(var i=this,t=0,a=e.length;t<a;t++)i.userRecordList.push({lastCreateTime:e[t].lastCreateTime,lastFinishTime:e[t].lastFinishTime,vehicleStatusName:e[t].vehicleStatusName,lastUseStatusName:e[t].lastUseStatusName,cellClassName:{vehicleStatusName:"_"+e[t].vehicleStatus}})},getVehicleUseRecordList:function(e){var i=this;1==e&&(i.recordPageInfo.pageNum=1),utility.interactWithServer({url:CONFIG.HOST+CONFIG.SERVICE.vehicleService+"?action="+CONFIG.ACTION.getVehicleUseRecordList,actionUrl:CONFIG.SERVICE.vehicleService,dataObj:{pageNum:i.recordPageInfo.pageNum,pageSize:i.recordPageInfo.pageSize,vehicleId:i.vehicleList[i.recordIndex].id},successCallback:function(e){200==e.code&&(i.userRecordList=[],i.recordPageInfo.count=e.count,i.formatRecord(e.data))}})},showRecordList:function(e){var i=this;i.isRecord=!0,i.recordIndex=e,i.itemInfo=i.vehicleList[i.recordIndex],i.getVehicleUseRecordList(!1)},toMapCoordinates:function(e){utility.setSessionStorage("fromInfo",null),utility.setSessionStorage("vehicleInfoFrom",e),setTimeout(function(){$(window.parent.document).find("#nav_Maps").bind("click"),$(window.parent.document).find("#nav_Maps").trigger("click")},200)}},created:function(){var e=this;utility.isLogin(!1),setTimeout(function(){e.getVehicleList(!0),e.getAllVehicleList(),e.getCompanyList(),e.getTerminalList(),setInterval(function(){e.getVehicleList(!1),e.getAllVehicleList()},3e3),e.$watch("pageInfo",function(){e.getVehicleList(!0)},{deep:!0})},500)}})})();